<!DOCTYPE html>
<html>

<head>
    <title>Now You See Me</title>
    <meta charset="UTF-8">

    <!--     <script src='https://aframe.io/releases/0.9.2/aframe.min.js'></script> -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <!--     <script src="https://raw.githack.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script> -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <!--     GIFëŠ” aframe 0.9.2 ë²„ì „ì—ì„œ ë™ì‘ì‘ -->
    <!--     <script src="https://rawgit.com/mayognaise/aframe-gif-shader/master/dist/aframe-gif-shader.min.js"></script> -->

    <style>
        /* í˜„ì¬ìœ„ì¹˜ í‘œì‹œì°½ */
        #gpsDisplay {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            padding: 8px 12px;
            font-family: monospace;
            font-size: 14px;
            border-radius: 6px;
            z-index: 999;
            white-space: pre-line;
        }

        /* ëª©ì ì§€ GPS ì…ë ¥ ì°½ */
        #targetForm {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 6px;
        }

        #targetForm input {
            width: 160px;
            /* ì…ë ¥ì°½ í­ ì œí•œ */
        }

        #updateTarget {
            align-self: flex-end;
            margin-top: 8px;
            padding: 6px 12px;
            width: auto;
            /* ë²„íŠ¼ì´ í…ìŠ¤íŠ¸ì— ë§ê²Œ */
        }

        /* ê·¼ì²˜ ì™”ì„ë•Œ ë©”ì„¸ì§€ ì°½ */
        #arrivalMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 128, 0, 0.85);
            color: #fff;
            padding: 20px 40px;
            font-size: 22px;
            font-weight: bold;
            border-radius: 12px;
            display: none;
            z-index: 999;
        }

        /* ì—…ë¡œë“œ ë²„íŠ¼ */
        #uploadBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background-color: #007bff;
            color: white;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 9999;
        }

        #uploadBtn:hover {
            background-color: #0056b3;
        }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">
    <div id="gpsDisplay">ğŸ“ GPS Loading...</div>

    <!-- í† ê¸€ ë²„íŠ¼, íƒ€ê²Ÿ ì…ë ¥ ì°½ í¼ì¹˜ê¸°ê¸° -->
    <button id="toggleFormBtn" style="position: absolute; top: 134px; right: 10px; z-index: 999;">
        ğŸ¯ Input Target â–¼
    </button>

    <button id="uploadBtn">ğŸ“¤ Upload</button>


    <!-- íƒ€ê²Ÿ ì…ë ¥ í¼ -->
    <div id="targetForm"
        style="display: none; position: absolute; top: 160px; right: 10px; background: #fff; padding: 10px; border-radius: 6px; z-index: 999;">
        Lat: <input type="number" id="targetLat" step="0.000001"><br />
        Lon: <input type="number" id="targetLon" step="0.000001"><br />
        <button id="updateTarget" onclick="updateTarget()">Apply</button>
    </div>

    <!-- íƒ€ê²Ÿ ê·¼ì²˜ ë©”ì„¸ì§€ ë‚´ìš© -->
    <div id="arrivalMessage">ğŸ‰ You are near the target!</div>

    <!-- í”ë“¤ë¦¼ ë³´ì •í• ë•Œ gpsMinAccuracyë¥¼ 50ìœ¼ë¡œ í•˜ëŠ”ê²Œ ê°€ì´ë“œì¸ë° ì˜ ì•ˆë˜ëŠ”ë“¯ -->
    <a-scene embedded xr-mode-ui="enabled: false"
        arjs="sourceType: webcam; gpsMinAccuracy: 100; debugUIEnabled: false;">
        <a-camera gps-camera rotation-reader>
            <a-entity cursor="rayOrigin: mouse" raycaster="objects: .intersectable" visible="false">
            </a-entity>
        </a-camera>

        <!-- ì´ë¯¸ì§€ í‘œì‹œ ê°ì²´ -->
        <!-- í•˜ëŠ˜ í–¥í• ë•Œ ë©”ì„¸ì§€ -->
        <!-- <a-image id="skyMessage" position="0 50 50" src="https://d2i253d5k7v4zj.cloudfront.net/uploads/moon.png"
            width="5" height="5" visible="true" class="intersectable" look-at="[camera]">
        </a-image> -->
    </a-scene>


    <script>
        //cognito ì¸ì¦ í™•ì¸
        const clientId = "1rm7ulr2vl74rfbm43ltjrj84p";
        const domain = "https://ap-northeast-2cdd1nzonw.auth.ap-northeast-2.amazoncognito.com";
        const redirectUri = "https://merkava5871.github.io/ar/view.html";

        // URLì—ì„œ code ì¶”ì¶œ
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get("code");
        const storedIdToken = localStorage.getItem("idToken");
        console.log("ì €ì¥ëœ í† í° :", storedIdToken);

        // âœ… í† í° ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
        function isTokenValid(token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const now = Math.floor(Date.now() / 1000);
                return payload.exp && payload.exp > now;
            } catch (e) {
                return false;
            }
        }

        //code ìˆê³  í† í° ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šì„ê²½ìš° í† í° ë°›ì•„ì˜¤ê¸°
        if (code && !isTokenValid(storedIdToken)) {
            fetch(`${domain}/oauth2/token`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: `grant_type=authorization_code&client_id=${clientId}&code=${code}&redirect_uri=${encodeURIComponent(redirectUri)}`
            })
                .then(res => res.json())
                .then(data => {
                    const idToken = data.id_token;
                    if (idToken) {
                        localStorage.setItem("idToken", idToken);
                        console.log("âœ… ë¡œê·¸ì¸ ì„±ê³µ, í† í° ì €ì¥ë¨", idToken);
                    } else {
                        alert("â— í† í°ì„ ë°›ì•„ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤..");
                        window.location.href = "https://merkava5871.github.io/ar/index.html";
                    }
                })
                .catch(err => {
                    console.error("â— í† í° ìš”ì²­ ì‹¤íŒ¨:", err);
                    window.location.href = "https://merkava5871.github.io/ar/index.html";
                });

        } else if (code && isTokenValid(storedIdToken)) {
            // âœ… í† í°ì´ ìˆê³  ìœ íš¨í•˜ë©´ ì¸ì¦ í†µê³¼
            console.log("âœ… ê¸°ì¡´ í† í° ìœ íš¨, ì¸ì¦ í†µê³¼");

        } else {
            alert("â— ë¡œê·¸ì¸ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
            window.location.href = "https://merkava5871.github.io/ar/index.html";
        }

        // ì˜¤ë¸Œì íŠ¸ ì´ë¯¸ì§€ url ì¶”ì¶œ
        function extractFromMaterial(materialStr) {
            const match = materialStr.match(/src:\s*(?:url\()?(\S+?)(?:\)|;|$)/);
            return match ? match[1].replace(/['"]/g, '') : '';
        }

        let nearbyObjectCount = 0; //20250807  ê·¼ë°© ì˜¤ë¸Œì íŠ¸ ê°œìˆ˜ ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸

        // metadataê°€ì ¸ì˜¤ê¸°
        function fetchObjectsNearby(lat, lon) {
            const idToken = localStorage.getItem("idToken");
            console.log("idToken:", idToken);
            if (!idToken) {
                alert("â—ì¸ì¦ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                window.location.href = "https://nyse.hae-szg.online/ar/index.html";
                return;
            }

            fetch('https://4pigo50fm6.execute-api.ap-northeast-2.amazonaws.com/prod/objects', {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${idToken}`
                }
            })
                .then(res => res.json())
                .then(api => {
                    const data = JSON.parse(api.body);
                    // console.log("âœ… ë°›ì•„ì˜¨ ë°ì´í„°:", data); // ì—¬ê¸°ì— êµ¬ì¡° ë¡œê·¸ ì°ì–´ë³´ê¸°

                    const scene = document.querySelector('a-scene');

                    let count = 0; //20250807 ê·¼ë°© visible ì˜¤ë¸Œì íŠ¸ ê°œìˆ˜

                    data.forEach((item, i) => {
                        //20250807 ì˜¤ë¸Œì íŠ¸ ê°œìˆ˜ ì¹´ìš´íŠ¸
                        const isVisible = item.visible === 1 || item.visible === "1";
                        const hasLocation = item.latitude && item.longitude;

                        // ê±°ë¦¬ ì¡°ê±´ ì²´í¬
                        if (isVisible && hasLocation) {
                            const distance = haversineDistance(lat, lon, item.latitude, item.longitude);
                            if (distance <= 50) { //50m ì´ë‚´ ì˜¤ë¸Œì íŠ¸ ì¹´ìš´íŠ¸
                                count++;
                            }
                        }

                        //20250807  í‘œì‹œí•˜ì§€ ì•Šê¸°ë¡œ ì„¤ì •ëœ ì˜¤ë¸Œì íŠ¸ëŠ” ê±´ë„ˆëœ€
                        if (!isVisible) return;

                        const entity = document.createElement('a-entity');

                        //20250723 ì¢Œí‘œ ì—†ëŠ” ì˜¤ë¸Œì íŠ¸ í‘œì‹œ
                        const isGlobalObject = !item.latitude || !item.longitude;

                        if (isGlobalObject) {
                            // ìœ„ì¹˜ ì—†ëŠ” ì „ì—­ ì˜¤ë¸Œì íŠ¸ â†’ ì¼ë°˜ A-Frame ê³µê°„ì— ë°°ì¹˜
                            // entity.setAttribute('position', item.position || '0 0 -5');
                        } else {
                            // ìœ„ì¹˜ ê¸°ë°˜ ì˜¤ë¸Œì íŠ¸ â†’ GPS ì»´í¬ë„ŒíŠ¸ë¡œ ë°°ì¹˜
                            entity.setAttribute('gps-entity-place', `latitude: ${item.latitude}; longitude: ${item.longitude}`);
                            // entity.setAttribute('position', item.position || '0 0 0');
                        }
                        // entity.setAttribute('gps-entity-place', `latitude: ${item.latitude}; longitude: ${item.longitude}`);

                        entity.setAttribute('geometry', item.geometry || 'primitive: plane');
                        //aframe ìƒìœ„ ë²„ì „ì—ì„œëŠ” transparent ì—†ì´ëŠ” ë°”íƒ•ì´ ê²€ì •ìœ¼ë¡œ ë‚˜ì˜´
                        const materialStr = item.material || 'color: red';
                        entity.setAttribute('material', `${materialStr}; transparent: true; alphaTest: 0.01`);
                        entity.setAttribute('position', item.position || '0 0 0');
                        entity.setAttribute('look-at', '[gps-camera]');
                        entity.setAttribute('id', `entity-${i}`);
                        entity.setAttribute('scale', item.scale || '1 1 1');
                        entity.setAttribute('class', 'intersectable');
                        // entity.setAttribute('smooth-follow', 'factor: 0.1');

                        // rotation ì„¤ì • (ì˜µì…˜)
                        if (item.rotation) {
                            entity.setAttribute('rotation', item.rotation);
                        }

                        entity.addEventListener('mouseenter', () => {
                            console.log("ğŸ¯ raycaster ê°ì§€ë¨");
                        });

                        // ë°œê²¬ ì˜¤ë¸Œì íŠ¸ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ ì„¤ì •
                        entity.addEventListener('click', (a) => {
                            a.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€ (ì¤‘ìš”!)
                            alert("âœ¨ Now you got me! âœ¨");
                            const url = extractFromMaterial(item.material);
                            if (!url) {
                                console.warn("â— ì´ë¯¸ì§€ URL ì¶”ì¶œ ì‹¤íŒ¨");
                                return;
                            }

                            const ext = url.split('.').pop().split('?')[0];
                            const filename = `ar-content-${Date.now()}.${ext}`;
                            // ëª¨ë°”ì¼ì—ì„œ ì•ˆì •ì ìœ¼ë¡œ ì‘ë™
                            setTimeout(() => {
                                window.open(url, '_blank');
                            }, 0);
                            // downloadFile(url, filename);
                        });
                        scene.appendChild(entity);
                    });
                    // ì¡°ê±´ ì¶©ì¡± ì˜¤ë¸Œì íŠ¸ ìµœì¢… ê°œìˆ˜ ì €ì¥
                    nearbyObjectCount = count;

                })
                .catch(err => {
                    console.error('â— JSON ë¡œë”© ì‹¤íŒ¨:', err);
                });
        }


        // íƒ€ê²Ÿ ìœ„ì¹˜ ì…ë ¥,ì €ì¥
        function updateTarget() {
            targetLat = parseFloat(document.getElementById("targetLat").value);
            targetLon = parseFloat(document.getElementById("targetLon").value);
            alert(`âœ”ï¸ Target applied!: ${targetLat}, ${targetLon}`);
        }


        // í˜„ì¬ìœ„ì¹˜ì—ì„œ íƒ€ê²Ÿê¹Œì§€ì˜ ê±°ë¦¬ ê³„ì‚°
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth radius in meters
            const toRad = deg => deg * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // íƒ€ê²Ÿ ë„ì°© ë©”ì„¸ì§€
        const arrivalMessage = document.getElementById("arrivalMessage");
        let hasArrived = false; // ì¤‘ë³µ ë©”ì‹œì§€ ë°©ì§€
        function showArrivalMessage() {
            arrivalMessage.style.display = 'block';
            setTimeout(() => {
                arrivalMessage.style.display = 'none';
            }, 4000); // 4ì´ˆ í›„ ìë™ ìˆ¨ê¹€
        }



        // íƒ€ê²Ÿ GPS ë³€ìˆ˜
        let targetLat = null;
        let targetLon = null;
        let objectsLoaded = false;


        // í˜„ì¬ìœ„ì¹˜ í‘œì‹œ
        const gpsDisplay = document.getElementById("gpsDisplay");
        navigator.geolocation.watchPosition(
            (pos) => {
                currentLat = pos.coords.latitude;
                currentLon = pos.coords.longitude;

                const lat = pos.coords.latitude.toFixed(6);
                const lon = pos.coords.longitude.toFixed(6);
                const alt = pos.coords.altitude !== null ? pos.coords.altitude.toFixed(1) + "m" : "none";
                //ê¸°ìš¸ê¸° í‘œì‹œ
                const camera = document.querySelector('[gps-camera]');
                const rot = camera.getAttribute('rotation');
                const pitch = rot ? rot.x.toFixed(1) + "Â°" : "measuring";

                let distanceStr = "No target";
                if (targetLat && targetLon) {
                    const distance = haversineDistance(pos.coords.latitude, pos.coords.longitude, targetLat, targetLon);
                    distanceStr = distance.toFixed(1) + "m";

                    // íƒ€ê²Ÿê¹Œì§€ì˜ ê±°ë¦¬ê°€ 10m ì´ë‚´ë©´ ë©”ì„¸ì§€ í‘œì‹œì‹œ
                    if (distance < 10 && !hasArrived) {
                        showArrivalMessage();
                        hasArrived = true;
                    } else if (distance >= 10) {
                        hasArrived = false; // ë‹¤ì‹œ ë©€ì–´ì§€ë©´ ë¦¬ì…‹
                    }
                }

                // GPS ì²˜ìŒ í™•ì¸ë˜ì—ˆì„ ë•Œë§Œ fetch ì‹¤í–‰
                if (!objectsLoaded) {
                    fetchObjectsNearby(currentLat, currentLon);
                    objectsLoaded = true;
                }

                gpsDisplay.textContent =
                    `â†”ï¸ Lat: ${lat}\nâ†•ï¸ Lon: ${lon}\nğŸ—» Alt: ${alt}\nğŸ“ Angle: ${pitch}\nâ­ Obj(50m): ${nearbyObjectCount}\nğŸ“ Dis: ${distanceStr}`;
            },
            (err) => {
                gpsDisplay.textContent = "â— GPS not Found.";
            },
            { enableHighAccuracy: true }
        );

        // í† ê¸€ ë²„íŠ¼ í¼ì¹˜ê¸°, ì¤„ì´ê¸°ê¸°
        document.getElementById("toggleFormBtn").addEventListener("click", () => {
            const form = document.getElementById("targetForm");
            form.style.display = (form.style.display === "none") ? "block" : "none";
        });

        // ì´ë¯¸ì§€ í„°ì¹˜ ë‹¤ìš´ë¡œë“œ êµ¬í˜„
        document.addEventListener("DOMContentLoaded", () => {
            const imageEl = document.getElementById("skyMessage");

            // ëª¨ë°”ì¼ê³¼ PC ëª¨ë‘ ëŒ€ì‘
            imageEl.addEventListener("click", handleDownload);
            imageEl.addEventListener("touchend", handleDownload);

            function handleDownload(e) {
                e.preventDefault();
                alert("âœ¨ Now you got me! âœ¨");
                const url = imageEl.getAttribute("src");
                const ext = url.split('.').pop().split('?')[0];
                const filename = `ar-content-${Date.now()}.${ext}`;

                // ëª¨ë°”ì¼ í˜¸í™˜ì„ ìœ„í•´ window.open ë°©ì‹ ì‚¬ìš©
                window.open(url, '_blank');
            }
        });

        // upload í˜ì´ì§€ ë§í¬
        document.getElementById("uploadBtn").addEventListener("click", () => {
            // í˜„ì¬ í† í° ë“± ì¿¼ë¦¬ìŠ¤íŠ¸ë§ ë¶™ì—¬ì„œ ì „ë‹¬í•  ìˆ˜ë„ ìˆìŒ
            location.href = `https://merkava5871.github.io/ar/upload.html?code=${code}`;
        });

    </script>

</body>

</html>
