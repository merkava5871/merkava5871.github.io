<!DOCTYPE html>
<html>

<head>
    <title>HAE AR by SZG</title>
    <!--     <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script> -->
    <script src='https://aframe.io/releases/0.9.2/aframe.min.js'></script>
    <script src="https://raw.githack.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.min.js"></script>
    <script src="https://rawgit.com/mayognaise/aframe-gif-shader/master/dist/aframe-gif-shader.min.js"></script>

    <style>
        /* í˜„ì¬ìœ„ì¹˜ í‘œì‹œì°½ */
        #gpsDisplay {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            padding: 8px 12px;
            font-family: monospace;
            font-size: 14px;
            border-radius: 6px;
            z-index: 999;
            white-space: pre-line;
        }
        
        /* ëª©ì ì§€ GPS ì…ë ¥ ì°½ */
        #targetForm {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
            z-index: 999;
        }

        /* ê·¼ì²˜ ì™”ì„ë•Œ ë©”ì„¸ì§€ ì°½ */
        #arrivalMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 128, 0, 0.85);
            color: #fff;
            padding: 20px 40px;
            font-size: 22px;
            font-weight: bold;
            border-radius: 12px;
            display: none;
            z-index: 999;
        }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">
    <div id="gpsDisplay">ğŸ“ ìœ„ì¹˜ í™•ì¸ ì¤‘...</div>

    <!-- í† ê¸€ ë²„íŠ¼, íƒ€ê²Ÿ ì…ë ¥ ì°½ í¼ì¹˜ê¸°ê¸° -->
    <button id="toggleFormBtn" style="position: absolute; top: 100px; right: 10px; z-index: 999;">
        ğŸ¯ íƒ€ê²Ÿ ìœ„ì¹˜ ì„¤ì •
    </button>

    <!-- íƒ€ê²Ÿ ì…ë ¥ í¼ -->
    <div id="targetForm"
        style="display: none; position: absolute; top: 140px; right: 10px; background: #fff; padding: 10px; border-radius: 6px; z-index: 999;">
        ìœ„ë„: <input type="number" id="targetLat" step="0.000001"><br />
        ê²½ë„: <input type="number" id="targetLon" step="0.000001"><br />
        <button onclick="updateTarget()">ì ìš©</button>
    </div>

    <!-- íƒ€ê²Ÿ ê·¼ì²˜ ë©”ì„¸ì§€ ë‚´ìš© -->
    <div id="arrivalMessage">ğŸ‰ íƒ€ê²Ÿ ìœ„ì¹˜ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤!</div>

    <a-scene vr-mode-ui="enabled: false" embedded arjs="sourceType: webcam; gpsMinAccuracy: 100; debugUIEnabled: false;">
        <a-camera gps-camera rotation-reader sky-detector></a-camera>

        <!-- ì´ë¯¸ì§€ í‘œì‹œ ê°ì²´ -->
<a-entity id="skyMessage" position="0 4 -3"
            text="value: â˜ï¸ í•˜ëŠ˜ì„ í–¥í•´ ë¹„ì¶”ì…¨êµ°ìš”!; align: center; color: yellow; width: 6" visible="false"></a-entity>
        
         <!-- í‰ë©´ ì´ë¯¸ì§€ ë°•ìŠ¤ ì…ì²´ë¡œ í‘œí˜„ -->
          <!-- positionì€ GPS ê¸°ì¤€ ìƒëŒ€ ìœ„ì¹˜ë¡œ ì‘ìš©í•´ â€” ì˜ˆ: 0 1 -3ì€ í•´ë‹¹ ì¢Œí‘œì—ì„œ 1m ìœ„, 3m ì• -->
        <a-entity geometry="primitive: plane; height: 2; width: 2"
            material="src: https://d2i253d5k7v4zj.cloudfront.net/Jiahn.png; side: double;"
            gps-entity-place="latitude: 37.526676; longitude: 126.887700;" look-at="[gps-camera]" scale="5 5 5"
            position="0 0 0"></a-entity>

        <!-- í‰ë©´ ì´ë¯¸ì§€ í‘œí˜„ -->
        <!--       <a-image
        src="https://made-by-bg.s3.ap-northeast-2.amazonaws.com/Jiahn.png"
        gps-entity-place="latitude: 37.526590; longitude: 126.887970;"
        look-at="[gps-camera]"
        scale="1 1 1"
        material="color: white; transparent: true; opacity: 1; side: double;"
        position="0 1 -1"
      ></a-image> -->

        <!-- GIF ì´ë¯¸ì§€ í‘œí˜„ -->
        <!--       <a-entity
        geometry="primitive: plane; height: 2; width: 2"
        material="shader: gif; src: url(https://made-by-bg.s3.ap-northeast-2.amazonaws.com/arrow_direction_spin_right_md_nwm_v2.gif)"
        position="0 1.5 -3"
      ></a-entity> -->
    </a-scene>

    <script>
        // íƒ€ê²Ÿ GPS ë³€ìˆ˜
        let targetLat = null;
        let targetLon = null;

        // íƒ€ê²Ÿ ë„ì°© ì´ë¯¸ì§€
        const arrivalMessage = document.getElementById("arrivalMessage");
        let hasArrived = false; // ì¤‘ë³µ ë©”ì‹œì§€ ë°©ì§€
        function showArrivalMessage() {
            arrivalMessage.style.display = 'block';
            setTimeout(() => {
                arrivalMessage.style.display = 'none';
            }, 4000); // 4ì´ˆ í›„ ìë™ ìˆ¨ê¹€
        }

        // í˜„ì¬ìœ„ì¹˜ì—ì„œ íƒ€ê²Ÿê¹Œì§€ì˜ ê±°ë¦¬ ê³„ì‚°ì‚°
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const toRad = deg => deg * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // íƒ€ê²Ÿ ìœ„ì¹˜ ì…ë ¥,ì €ì¥ì¥
        function updateTarget() {
            targetLat = parseFloat(document.getElementById("targetLat").value);
            targetLon = parseFloat(document.getElementById("targetLon").value);
            alert(`âœ”ï¸ íƒ€ê²Ÿ ìœ„ì¹˜ ì„¤ì •ë¨: ${targetLat}, ${targetLon}`);
        }

        // í˜„ì¬ìœ„ì¹˜ í‘œì‹œì‹œ
        const gpsDisplay = document.getElementById("gpsDisplay");
        navigator.geolocation.watchPosition(
            (pos) => {
                const lat = pos.coords.latitude.toFixed(6);
                const lon = pos.coords.longitude.toFixed(6);
                const alt = pos.coords.altitude !== null ? pos.coords.altitude.toFixed(1) + "m" : "ì•Œ ìˆ˜ ì—†ìŒ";

                let distanceStr = "íƒ€ê²Ÿ ë¯¸ì„¤ì •";
                if (targetLat && targetLon) {
                    const distance = haversineDistance(pos.coords.latitude, pos.coords.longitude, targetLat, targetLon);
                    distanceStr = distance.toFixed(1) + "m";

                    // íƒ€ê²Ÿê¹Œì§€ì˜ ê±°ë¦¬ê°€ 10m ì´ë‚´ë©´ ë©”ì„¸ì§€ í‘œì‹œì‹œ
                    if (distance < 10 && !hasArrived) {
                        showArrivalMessage();
                        hasArrived = true;
                    } else if (distance >= 10) {
                        hasArrived = false; // ë‹¤ì‹œ ë©€ì–´ì§€ë©´ ë¦¬ì…‹
                    }
                }

                gpsDisplay.textContent =
                    `ğŸ“ ìœ„ë„: ${lat}\nğŸ“ ê²½ë„: ${lon}\nğŸ“ ê±°ë¦¬: ${distanceStr}\nğŸ—» ê³ ë„: ${alt}`;
            },
            (err) => {
                gpsDisplay.textContent = "â— GPS ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            },
            { enableHighAccuracy: true }
        );

        // í† ê¸€ ë²„íŠ¼ í¼ì¹˜ê¸°, ì¤„ì´ê¸°ê¸°
        document.getElementById("toggleFormBtn").addEventListener("click", () => {
            const form = document.getElementById("targetForm");
            form.style.display = (form.style.display === "none") ? "block" : "none";
        });

                // í•˜ëŠ˜í–¥í• ë–„ ë³´ì´ê²Œ
  // 1. ì¹´ë©”ë¼ íšŒì „ê°’ì„ ì–»ê¸° ìœ„í•œ rotation-reader
  AFRAME.registerComponent('rotation-reader', {
    tick: function () {
      const rot = this.el.object3D.rotation;
      this.el.setAttribute('rotation', {
        x: THREE.Math.radToDeg(rot.x),
        y: THREE.Math.radToDeg(rot.y),
        z: THREE.Math.radToDeg(rot.z)
      });
    }
  });

  // 2. í•˜ëŠ˜ ê°ì§€ í›„ ë©”ì‹œì§€ í‘œì‹œ
  AFRAME.registerComponent('sky-detector', {
    tick: function () {
      const rot = this.el.getAttribute('rotation');
      if (!rot) return;

      const pitch = rot.x; // ìƒí•˜ ê°ë„
      const message = document.querySelector('#skyMessage');

      if (pitch < -30) {
        message.setAttribute('visible', true);
      } else {
        message.setAttribute('visible', false);
      }
    }
  })
    </script>


</body>

</html>
